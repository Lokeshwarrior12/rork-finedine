ARG GO_VERSION=1.24
FROM golang:${GO_VERSION}-bookworm AS builder

WORKDIR /app

COPY go.mod go.sum ./
COPY . .

# Rewrite module name AND all import paths in source files to match
RUN go mod edit -module github.com/Lokeshwarrior12/rork-finedine/backend && \
    find . -name "*.go" -exec sed -i \
      's|"rork-finedine/backend/|"github.com/Lokeshwarrior12/rork-finedine/backend/|g' {} +

RUN go mod tidy

RUN go build -v -o /run-app .


FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /run-app /usr/local/bin/run-app

EXPOSE 8080

CMD ["run-app"]
